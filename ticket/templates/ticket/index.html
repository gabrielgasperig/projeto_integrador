{% extends 'global/base.html' %}

{% block content %}
<div class="p-4 md:p-8 min-h-screen" x-data="{ 
    unassignedOpen: true, 
    assignedToMeOpen: true,
    unassignedCount: {{ unassigned_tickets|length }},
    assignedCount: {{ assigned_to_me|length }}
}" x-init="
    setInterval(async () => {
        try {
            const response = await fetch('{% url 'ticket:check_new_tickets' %}');
            const data = await response.json();
            if (data.unassigned_count !== unassignedCount || data.assigned_count !== assignedCount) {
                window.location.reload();
            }
        } catch (error) {
            console.error('Erro ao verificar novos tickets:', error);
        }
    }, 10000)
">
    <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">
        Fila de Atendimento
    </h1>

    <div class="mb-8">
        <div @click="unassignedOpen = !unassignedOpen" class="flex items-center justify-between p-4 bg-gray-200 rounded-t-lg cursor-pointer">
            <h2 class="font-bold text-gray-700">Aguardando Atendimento</h2>
            <svg class="w-6 h-6 text-gray-600 transition-transform" :class="{'rotate-180': !unassignedOpen}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
        </div>
        <div x-show="unassignedOpen" class="bg-white shadow-md rounded-b-lg overflow-hidden">
            <div class="overflow-x-auto">
                 <table class="min-w-full leading-normal">
                    <thead>
                        <tr>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <a href="?sort_unassigned={% if current_sort_unassigned == 'title' %}-title{% else %}title{% endif %}" class="hover:text-gray-900">Título</a>
                            </th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <a href="?sort_unassigned={% if current_sort_unassigned == 'category' %}-category{% else %}category{% endif %}" class="hover:text-gray-900">Categoria</a>
                            </th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <a href="?sort_unassigned={% if current_sort_unassigned == 'subcategory' %}-subcategory{% else %}subcategory{% endif %}" class="hover:text-gray-900">Subcategoria</a>
                            </th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <a href="?sort_unassigned={% if current_sort_unassigned == 'owner' %}-owner{% else %}owner{% endif %}" class="hover:text-gray-900">Criado por</a>
                            </th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <a href="?sort_unassigned={% if current_sort_unassigned == '-created_date' %}created_date{% else %}-created_date{% endif %}" class="hover:text-gray-900">Data de criação</a>
                            </th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <a href="?sort_unassigned={% if current_sort_unassigned == 'status' %}-status{% else %}status{% endif %}" class="hover:text-gray-900">Status</a>
                            </th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <a href="?sort_unassigned={% if current_sort_unassigned == 'priority' %}-priority{% else %}priority{% endif %}" class="hover:text-gray-900">Prioridade</a>
                            </th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <a href="?sort_unassigned={% if current_sort_unassigned == 'sla_deadline' %}-sla_deadline{% else %}sla_deadline{% endif %}" class="hover:text-gray-900">SLA</a>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ticket in unassigned_tickets %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-5 py-4 border-b border-gray-200 text-sm">
                                    <a href="{% url 'ticket:ticket_detail' ticket.id %}" class="text-sm text-blue-600 hover:text-blue-900 font-semibold">{{ ticket.title }}</a>
                                </td>
                                <td class="px-5 py-4 border-b border-gray-200 text-sm">
                                    {% if ticket.category %}
                                        <span class="px-2 py-1 rounded-md text-sm font-medium bg-blue-100 text-blue-800">
                                            {{ ticket.category.name }}
                                        </span>
                                    {% else %}
                                        <span class="text-sm text-gray-500">Sem categoria</span>
                                    {% endif %}
                                </td>
                                <td class="px-5 py-4 border-b border-gray-200 text-sm">
                                    {% if ticket.subcategory %}
                                        <span class="px-2 py-1 rounded-md text-sm font-medium bg-blue-100 text-blue-800">
                                            {{ ticket.subcategory.name }}
                                        </span>
                                    {% else %}
                                        <span class="text-sm text-gray-500">Sem subcategoria</span>
                                    {% endif %}
                                </td>
                                <td class="px-5 py-4 border-b border-gray-200 text-sm">
                                    <span class="text-sm">{{ ticket.owner.first_name }} {{ ticket.owner.last_name }}</span>
                                </td>
                                <td class="px-5 py-4 border-b border-gray-200 text-sm">
                                    <span class="text-sm">{{ ticket.created_date|date:"d/m/Y H:i" }}</span>
                                </td>
                                <td class="px-5 py-4 border-b border-gray-200 text-sm">
                                    <span class="px-2 py-1 rounded-md text-sm font-medium
                                        {% if ticket.status == 'Aberto' %} bg-blue-100 text-blue-800 {% endif %}
                                        {% if ticket.status == 'Em Andamento' %} bg-yellow-100 text-yellow-800 {% endif %}
                                        {% if ticket.status == 'Fechado' %} bg-green-100 text-green-800 {% endif %}
                                    ">{{ ticket.status }}</span>
                                </td>
                                <td class="px-5 py-4 border-b border-gray-200 text-sm">
                                    <span class="px-2 py-1 rounded-md text-sm font-medium
                                        {% if ticket.priority == 'Baixa' %} bg-gray-100 text-gray-800 {% endif %}
                                        {% if ticket.priority == 'Média' %} bg-yellow-100 text-yellow-800 {% endif %}
                                        {% if ticket.priority == 'Alta' %} bg-orange-100 text-orange-800 {% endif %}
                                        {% if ticket.priority == 'Urgente' %} bg-red-100 text-red-800 {% endif %}
                                    ">{{ ticket.priority }}</span>
                                </td>
                                <td class="px-5 py-4 border-b border-gray-200 text-sm">
                                    {% with sla_status=ticket.sla_status %}
                                        <span class="px-2 py-1 rounded-md text-sm font-medium
                                            {% if sla_status == 'No Prazo' %} bg-gray-100 text-gray-800 {% endif %}
                                            {% if sla_status == 'Atenção' %} bg-yellow-100 text-yellow-800 {% endif %}
                                            {% if sla_status == 'Violado' %} bg-red-100 text-red-800 {% endif %}
                                            {% if sla_status == 'Cumprido' %} bg-green-100 text-green-800 {% endif %}
                                        ">
                                            {{ sla_status }}
                                        </span>
                                    {% endwith %}
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="8" class="text-center py-10 text-gray-500">Nenhum ticket encontrado.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div>
        <div @click="assignedToMeOpen = !assignedToMeOpen" class="flex items-center justify-between p-4 bg-gray-200 rounded-t-lg cursor-pointer">
            <h2 class="font-bold text-gray-700">Em Atendimento</h2>
            <svg class="w-6 h-6 text-gray-600 transition-transform" :class="{'rotate-180': !assignedToMeOpen}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
        </div>
        <div x-show="assignedToMeOpen" class="bg-white shadow-md rounded-b-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full leading-normal">
                    <thead>
                        <tr>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <a href="?sort_assigned={% if current_sort_assigned == 'title' %}-title{% else %}title{% endif %}" class="hover:text-gray-900">Título</a>
                            </th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <a href="?sort_assigned={% if current_sort_assigned == 'category' %}-category{% else %}category{% endif %}" class="hover:text-gray-900">Categoria</a>
                            </th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <a href="?sort_assigned={% if current_sort_assigned == 'subcategory' %}-subcategory{% else %}subcategory{% endif %}" class="hover:text-gray-900">Subcategoria</a>
                            </th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <a href="?sort_assigned={% if current_sort_assigned == 'owner' %}-owner{% else %}owner{% endif %}" class="hover:text-gray-900">Criado por</a>
                            </th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <a href="?sort_assigned={% if current_sort_assigned == '-created_date' %}created_date{% else %}-created_date{% endif %}" class="hover:text-gray-900">Data de criação</a>
                            </th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <a href="?sort_assigned={% if current_sort_assigned == 'status' %}-status{% else %}status{% endif %}" class="hover:text-gray-900">Status</a>
                            </th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <a href="?sort_assigned={% if current_sort_assigned == 'priority' %}-priority{% else %}priority{% endif %}" class="hover:text-gray-900">Prioridade</a>
                            </th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                <a href="?sort_assigned={% if current_sort_assigned == 'sla_deadline' %}-sla_deadline{% else %}sla_deadline{% endif %}" class="hover:text-gray-900">SLA</a>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ticket in assigned_to_me %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-5 py-4 border-b border-gray-200 text-sm">
                                    <a href="{% url 'ticket:ticket_detail' ticket.id %}" class="text-sm text-blue-600 hover:text-blue-900 font-semibold">{{ ticket.title }}</a>
                                </td>
                                <td class="px-5 py-4 border-b border-gray-200 text-sm">
                                    {% if ticket.category %}
                                        <span class="px-2 py-1 rounded-md text-sm font-medium bg-blue-100 text-blue-800">
                                            {{ ticket.category.name }}
                                        </span>
                                    {% else %}
                                        <span class="text-sm text-gray-500">Sem categoria</span>
                                    {% endif %}
                                </td>
                                <td class="px-5 py-4 border-b border-gray-200 text-sm">
                                    {% if ticket.subcategory %}
                                        <span class="px-2 py-1 rounded-md text-sm font-medium bg-blue-100 text-blue-800">
                                            {{ ticket.subcategory.name }}
                                        </span>
                                    {% else %}
                                        <span class="text-sm text-gray-500">Sem subcategoria</span>
                                    {% endif %}
                                </td>
                                <td class="px-5 py-4 border-b border-gray-200 text-sm">
                                    <span class="text-sm">{{ ticket.owner.first_name }} {{ ticket.owner.last_name }}</span>
                                </td>
                                <td class="px-5 py-4 border-b border-gray-200 text-sm">
                                    <span class="text-sm">{{ ticket.created_date|date:"d/m/Y H:i" }}</span>
                                </td>
                                <td class="px-5 py-4 border-b border-gray-200 text-sm">
                                    <span class="px-2 py-1 rounded-md text-sm font-medium
                                        {% if ticket.status == 'Aberto' %} bg-blue-100 text-blue-800 {% endif %}
                                        {% if ticket.status == 'Em Andamento' %} bg-yellow-100 text-yellow-800 {% endif %}
                                        {% if ticket.status == 'Fechado' %} bg-green-100 text-green-800 {% endif %}
                                    ">{{ ticket.status }}</span>
                                </td>
                                <td class="px-5 py-4 border-b border-gray-200 text-sm">
                                    <span class="px-2 py-1 rounded-md text-sm font-medium
                                        {% if ticket.priority == 'Baixa' %} bg-gray-100 text-gray-800 {% endif %}
                                        {% if ticket.priority == 'Média' %} bg-yellow-100 text-yellow-800 {% endif %}
                                        {% if ticket.priority == 'Alta' %} bg-orange-100 text-orange-800 {% endif %}
                                        {% if ticket.priority == 'Urgente' %} bg-red-100 text-red-800 {% endif %}
                                    ">{{ ticket.priority }}</span>
                                </td>
                                <td class="px-5 py-4 border-b border-gray-200 text-sm">
                                    {% with sla_status=ticket.sla_status %}
                                        <span class="px-2 py-1 rounded-md text-sm font-medium
                                            {% if sla_status == 'No Prazo' %} bg-gray-100 text-gray-800 {% endif %}
                                            {% if sla_status == 'Atenção' %} bg-yellow-100 text-yellow-800 {% endif %}
                                            {% if sla_status == 'Violado' %} bg-red-100 text-red-800 {% endif %}
                                            {% if sla_status == 'Cumprido' %} bg-green-100 text-green-800 {% endif %}
                                        ">
                                            {{ sla_status }}
                                        </span>
                                    {% endwith %}
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="8" class="text-center py-10 text-gray-500">Nenhum ticket atribuído a você.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock content %}
