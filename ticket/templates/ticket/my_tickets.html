{% extends 'global/base.html' %}

{% block content %}
<div class="p-4 md:p-8" x-data="{ openTicketsOpen: true, closedTicketsOpen: true }">
    <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Meus Tickets</h1>
        <a href="{% url 'ticket:create' %}" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">
            + Criar Ticket
        </a>
    </div>

    <!-- Tabela de Tickets Abertos -->
    <div class="mb-8">
        <div @click="openTicketsOpen = !openTicketsOpen" class="flex items-center justify-between p-4 bg-gray-200 rounded-t-lg cursor-pointer">
            <h2 class="font-bold text-gray-700">Tickets em Aberto</h2>
            <svg class="w-6 h-6 text-gray-600 transition-transform" :class="{'rotate-180': !openTicketsOpen}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
        </div>
        <div x-show="openTicketsOpen" class="bg-white shadow-md rounded-b-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full leading-normal">
                    <thead>
                        <tr>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">Título</th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">Data</th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">Responsável</th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">Status</th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">SLA</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ticket in open_tickets %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-5 py-4 border-b border-gray-200 text-sm"><a href="{% url 'ticket:ticket_detail' ticket.id %}" class="text-blue-600 hover:text-blue-900 font-semibold">{{ ticket.title }}</a></td>
                            <td class="px-5 py-4 border-b border-gray-200 text-sm">{{ ticket.created_date|date:"d/m/Y H:i" }}</td>
                            <td class="px-5 py-4 border-b border-gray-200 text-sm">{{ ticket.assigned_to.get_full_name|default:"Ninguém" }}</td>
                            <td class="px-5 py-4 border-b border-gray-200 text-sm">
                                <span class="px-2 py-1 rounded-md text-xs font-medium {% if ticket.status == 'Aberto' %} bg-blue-100 text-blue-800 {% else %} bg-yellow-100 text-yellow-800 {% endif %}">{{ ticket.status }}</span>
                            </td>
                            <td class="px-5 py-4 border-b border-gray-200 text-sm">
                                {% with sla_status=ticket.sla_status %}
                                    <span class="px-2 py-1 rounded-md text-xs font-medium
                                        {% if sla_status == 'No Prazo' %} bg-gray-100 text-gray-800 {% endif %}
                                        {% if sla_status == 'Atenção' %} bg-yellow-100 text-yellow-800 {% endif %}
                                        {% if sla_status == 'Violado' %} bg-red-100 text-red-800 {% endif %}
                                        {% if sla_status == 'Cumprido' %} bg-green-100 text-green-800 {% endif %}
                                    ">
                                        {{ sla_status }}
                                    </span>
                                {% endwith %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="4" class="text-center py-10 text-gray-500">Não há tickets em aberto.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Tabela de Tickets Fechados -->
    <div>
        <div @click="closedTicketsOpen = !closedTicketsOpen" class="flex items-center justify-between p-4 bg-gray-200 rounded-t-lg cursor-pointer">
            <h2 class="font-bold text-gray-700">Tickets Concluídos</h2>
            <svg class="w-6 h-6 text-gray-600 transition-transform" :class="{'rotate-180': !closedTicketsOpen}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
        </div>
        <div x-show="closedTicketsOpen" class="bg-white shadow-md rounded-b-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full leading-normal">
                    <thead>
                         <tr>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">Título</th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">Data de Conclusão</th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">Responsável</th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">SLA</th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">Avaliação</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ticket in closed_tickets %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-5 py-4 border-b border-gray-200 text-sm"><a href="{% url 'ticket:ticket_detail' ticket.id %}" class="text-blue-600 hover:text-blue-900 font-semibold">{{ ticket.title }}</a></td>
                            <td class="px-5 py-4 border-b border-gray-200 text-sm">{{ ticket.closed_date|date:"d/m/Y H:i" }}</td>
                            <td class="px-5 py-4 border-b border-gray-200 text-sm">{{ ticket.assigned_to.get_full_name|default:"Ninguém" }}</td>
                            <td class="px-5 py-4 border-b border-gray-200 text-sm">
                                {% with sla_status=ticket.sla_status %}
                                    <span class="px-2 py-1 rounded-md text-xs font-medium
                                        {% if sla_status == 'No Prazo' %} bg-gray-100 text-gray-800 {% endif %}
                                        {% if sla_status == 'Atenção' %} bg-yellow-100 text-yellow-800 {% endif %}
                                        {% if sla_status == 'Violado' %} bg-red-100 text-red-800 {% endif %}
                                        {% if sla_status == 'Cumprido' %} bg-green-100 text-green-800 {% endif %}
                                    ">
                                        {{ sla_status }}
                                    </span>
                                {% endwith %}
                            </td>
                            <td class="px-5 py-4 border-b border-gray-200 text-sm">
                                {% if ticket.rating %}
                                    <span class="text-yellow-500">{{ ticket.get_rating_display }}</span>
                                {% else %}
                                    <span class="px-2 py-1 rounded-md text-xs font-medium bg-orange-100 text-orange-800">Pendente de Avaliação</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="4" class="text-center py-10 text-gray-500">Não há tickets concluídos.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}
