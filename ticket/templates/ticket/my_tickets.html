{% extends 'global/base.html' %}

{% block content %}
<div class="p-4 md:p-8 min-h-screen" x-data="{ 
    openTicketsOpen: true, 
    closedTicketsOpen: true,
    openCount: {{ open_tickets|length }},
    closedCount: {{ closed_tickets|length }}
}" x-init="
    setInterval(async () => {
        try {
            const response = await fetch('{% url 'ticket:check_my_tickets' %}');
            const data = await response.json();
            if (data.open_count !== openCount || data.closed_count !== closedCount) {
                window.location.reload();
            }
        } catch (error) {
            console.error('Erro ao verificar meus tickets:', error);
        }
    }, 10000)
">
    <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl md:text-3xl font-bold text-gray-800">
            Meus Tickets
        </h1>
    </div>

    <div class="mb-8">
        <div @click="openTicketsOpen = !openTicketsOpen" class="flex items-center justify-between p-4 bg-gray-200 rounded-t-lg cursor-pointer">
            <h2 class="font-bold text-gray-700">Tickets em Aberto</h2>
            <svg class="w-6 h-6 text-gray-600 transition-transform" :class="{'rotate-180': !openTicketsOpen}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
        </div>
        <div x-show="openTicketsOpen" class="bg-white shadow-md rounded-b-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full leading-normal">
                    <thead>
                        <tr>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">
                                <a href="?sort={% if current_sort == 'title' %}-title{% else %}title{% endif %}" class="hover:text-gray-900">Título</a>
                            </th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">
                                <a href="?sort={% if current_sort == 'category' %}-category{% else %}category{% endif %}" class="hover:text-gray-900">Categoria</a>
                            </th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">
                                <a href="?sort={% if current_sort == 'subcategory' %}-subcategory{% else %}subcategory{% endif %}" class="hover:text-gray-900">Subcategoria</a>
                            </th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">
                                <a href="?sort={% if current_sort == '-created_date' %}created_date{% else %}-created_date{% endif %}" class="hover:text-gray-900">Data de criação</a>
                            </th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">
                                <a href="?sort={% if current_sort == 'assigned_to' %}-assigned_to{% else %}assigned_to{% endif %}" class="hover:text-gray-900">Responsável</a>
                            </th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">
                                <a href="?sort={% if current_sort == 'status' %}-status{% else %}status{% endif %}" class="hover:text-gray-900">Status</a>
                            </th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">
                                <a href="?sort={% if current_sort == 'sla_deadline' %}-sla_deadline{% else %}sla_deadline{% endif %}" class="hover:text-gray-900">SLA</a>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ticket in open_tickets %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-5 py-4 border-b border-gray-200 text-sm">
                                <a href="{% url 'ticket:ticket_detail' ticket.id %}" class="text-sm text-blue-600 hover:text-blue-900 font-semibold">{{ ticket.title }}</a>
                            </td>
                            <td class="px-5 py-4 border-b border-gray-200 text-sm">
                                {% if ticket.category %}
                                    <span class="px-2 py-1 rounded-md text-sm font-medium bg-blue-100 text-blue-800">
                                        {{ ticket.category.name }}
                                    </span>
                                {% else %}
                                    <span class="text-sm text-gray-500">Sem categoria</span>
                                {% endif %}
                            </td>
                            <td class="px-5 py-4 border-b border-gray-200 text-sm">
                                {% if ticket.subcategory %}
                                    <span class="px-2 py-1 rounded-md text-sm font-medium bg-indigo-100 text-indigo-800">
                                        {{ ticket.subcategory.name }}
                                    </span>
                                {% else %}
                                    <span class="text-sm text-gray-500">Sem subcategoria</span>
                                {% endif %}
                            </td>
                            <td class="px-5 py-4 border-b border-gray-200 text-sm">
                                <span class="text-sm">{{ ticket.created_date|date:"d/m/Y H:i" }}</span>
                            </td>
                            <td class="px-5 py-4 border-b border-gray-200 text-sm">
                                <span class="text-sm">{{ ticket.assigned_to.get_full_name|default:"Ninguém" }}</span>
                            </td>
                            <td class="px-5 py-4 border-b border-gray-200 text-sm">
                                <span class="px-2 py-1 rounded-md text-sm font-medium {% if ticket.status == 'Aberto' %} bg-blue-100 text-blue-800 {% else %} bg-yellow-100 text-yellow-800 {% endif %}">{{ ticket.status }}</span>
                            </td>
                            <td class="px-5 py-4 border-b border-gray-200 text-sm">
                                {% with sla_status=ticket.sla_status %}
                                    <span class="px-2 py-1 rounded-md text-sm font-medium
                                        
                                        {% if sla_status == 'No Prazo' %} bg-gray-100 text-gray-800 {% endif %}
                                        {% if sla_status == 'Atenção' %} bg-yellow-100 text-yellow-800 {% endif %}
                                        {% if sla_status == 'Violado' %} bg-red-100 text-red-800 {% endif %}
                                        {% if sla_status == 'Cumprido' %} bg-green-100 text-green-800 {% endif %}
                                    ">
                                        {{ sla_status }}
                                    </span>
                                {% endwith %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="7" class="text-center py-10 text-gray-500">Não há tickets em aberto.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div>
        <div @click="closedTicketsOpen = !closedTicketsOpen" class="flex items-center justify-between p-4 bg-gray-200 rounded-t-lg cursor-pointer">
            <h2 class="font-bold text-gray-700">Tickets Concluídos</h2>
            <svg class="w-6 h-6 text-gray-600 transition-transform" :class="{'rotate-180': !closedTicketsOpen}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
        </div>
        <div x-show="closedTicketsOpen" class="bg-white shadow-md rounded-b-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full leading-normal">
                    <thead>
                         <tr>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">
                                <a href="?sort_closed={% if current_sort_closed == 'title' %}-title{% else %}title{% endif %}" class="hover:text-gray-900">Título</a>
                            </th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">
                                <a href="?sort_closed={% if current_sort_closed == 'category' %}-category{% else %}category{% endif %}" class="hover:text-gray-900">Categoria</a>
                            </th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">
                                <a href="?sort_closed={% if current_sort_closed == 'subcategory' %}-subcategory{% else %}subcategory{% endif %}" class="hover:text-gray-900">Subcategoria</a>
                            </th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">
                                <a href="?sort_closed={% if current_sort_closed == '-closed_date' %}closed_date{% else %}-closed_date{% endif %}" class="hover:text-gray-900">Data de Conclusão</a>
                            </th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">
                                <a href="?sort_closed={% if current_sort_closed == 'assigned_to' %}-assigned_to{% else %}assigned_to{% endif %}" class="hover:text-gray-900">Responsável</a>
                            </th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">SLA</th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">
                                <a href="?sort_closed={% if current_sort_closed == 'rating' %}-rating{% else %}rating{% endif %}" class="hover:text-gray-900">Avaliação</a>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ticket in closed_tickets %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-5 py-4 border-b border-gray-200 text-sm">
                                <a href="{% url 'ticket:ticket_detail' ticket.id %}" class="text-sm text-blue-600 hover:text-blue-900 font-semibold">{{ ticket.title }}</a>
                            </td>
                            <td class="px-5 py-4 border-b border-gray-200 text-sm">
                                {% if ticket.category %}
                                    <span class="px-2 py-1 rounded-md text-sm font-medium bg-blue-100 text-blue-800">
                                        {{ ticket.category.name }}
                                    </span>
                                {% else %}
                                    <span class="text-sm text-gray-500">Sem categoria</span>
                                {% endif %}
                            </td>
                            <td class="px-5 py-4 border-b border-gray-200 text-sm">
                                {% if ticket.subcategory %}
                                    <span class="px-2 py-1 rounded-md text-sm font-medium bg-blue-100 text-blue-800">
                                        {{ ticket.subcategory.name }}
                                    </span>
                                {% else %}
                                    <span class="text-sm text-gray-500">Sem subcategoria</span>
                                {% endif %}
                            </td>
                            <td class="px-5 py-4 border-b border-gray-200 text-sm">
                                <span class="text-sm">{{ ticket.closed_date|date:"d/m/Y H:i" }}</span>
                            </td>
                            <td class="px-5 py-4 border-b border-gray-200 text-sm">
                                <span class="text-sm">{{ ticket.assigned_to.get_full_name|default:"Ninguém" }}</span>
                            </td>
                            <td class="px-5 py-4 border-b border-gray-200 text-sm">
                                {% with sla_status=ticket.sla_status %}
                                    <span class="px-2 py-1 rounded-md text-sm font-medium
                                        {% if sla_status == 'No Prazo' %} bg-gray-100 text-gray-800 {% endif %}
                                        {% if sla_status == 'Atenção' %} bg-yellow-100 text-yellow-800 {% endif %}
                                        {% if sla_status == 'Violado' %} bg-red-100 text-red-800 {% endif %}
                                        {% if sla_status == 'Cumprido' %} bg-green-100 text-green-800 {% endif %}
                                    ">
                                        {{ sla_status }}
                                    </span>
                                {% endwith %}
                            </td>
                            <td class="px-5 py-4 border-b border-gray-200 text-sm">
                                {% if ticket.rating %}
                                    <div class="inline-flex items-center gap-0.5">
                                        {% for i in "12345" %}
                                            <svg class="w-5 h-5 {% if forloop.counter <= ticket.rating %}text-yellow-400{% else %}text-gray-300{% endif %}" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                            </svg>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <span class="px-2 py-1 rounded-md text-sm font-medium bg-orange-100 text-orange-800">Pendente de Avaliação</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="7" class="text-center py-10 text-gray-500">Não há tickets concluídos.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}
